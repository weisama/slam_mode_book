# 若机器人主控使用px4架构飞控（pixhawk），测试模块作为飞控的位置输入传感器

模块接线如图（以pixhawk 6c mini飞控为例）：

<table>
  <tr>
    <td style="border: 10px solid black; padding: 0;">
      <img src="https://github.com/user-attachments/assets/9d536db0-9f66-4be2-8aa1-75718c4331ee" width="100%">
    </td>
  </tr>
</table>

需准备一架可起飞的px4架构飞控的无人机，电脑下载上QGC

本教程以固件px4V1.13.3为例，飞控连接上QGC后设置参数如下：

<table>
  <tr>
    <td style="border: 10px solid black; padding: 0;">
      <img src="https://github.com/user-attachments/assets/62ecce61-c13e-4661-8cdc-dbde6f7e259c" width="100%">
    </td>
  </tr>
</table>

<table>
  <tr>
    <td style="border: 10px solid black; padding: 0;">
      <img src="https://github.com/user-attachments/assets/a803d799-19e6-420e-9244-278c5b77cad5" width="100%">
    </td>
  </tr>
</table>

<table>
  <tr>
    <td style="border: 10px solid black; padding: 0;">
      <img src="https://github.com/user-attachments/assets/ce74242f-d467-42b7-ac65-9fe3471c1bde" width="100%">
    </td>
  </tr>
</table>


| 参数名称 | 设置值 | 说明 |
|---------|--------|------|
| MAV_1_CONFIG | TELLEM2 | 将 MAVLink 第 1 通道映射到飞控的 TELEM2 接口 |
| MAV_1_MODE | Onboard | 设定为 Onboard 模式，用于连接模块 |
| SER_TEL2_BAUD | 921600 8N1 | 设定 TELEM2 串口波特率为 921600 bps，8 位数据位、无校验、1 位停止位 |
| MAV_1_RATE | 0 | 设定 MAVLink 通道 1 的数据速率（bytes/s），0 表示由飞控自适应 |
| EKF2_AID_MASK | 24 | EKF2 融合辅助源掩码：24=16+8，启用模块输入的位置（EV_POS）与偏航（EV_YAW） |
| EKF2_EVP_NOISE | 0.1 | 默认外部位置观测噪声（m） |
| EKF2_EVA_NOISE | 2.56 | 默认外部角度（偏航）观测噪声（deg） |
| EKF2_EV_DELAY | 175 | 默认外部数据相对 IMU 的延迟补偿（ms） |
| EKF2_HGT_MODE | 0 | 高度估计源：0=气压计，1=GPS，2=外部视觉，3=激光测距仪 |

设置参数后断电重连飞控确保参数生效
给模块上电，等待模块初始化10s，可在QGC的mavlink控制器中看见模块传给飞控的数据：

<table>
  <tr>
    <td style="border: 10px solid black; padding: 0;">
      <img src="https://github.com/user-attachments/assets/67a01143-6a5d-4e31-a5b1-8bfa62b4358a" width="100%">
    </td>
  </tr>
</table>

QGC中可以把飞控模式设置为定点

<table>
  <tr>
    <td style="border: 10px solid black; padding: 0;">
      <img src="https://github.com/user-attachments/assets/89e9e345-122c-484c-b3d0-87038eea847c" width="100%">
    </td>
  </tr>
</table>

无人机已实现位置闭环，可起飞测试定点效果

# 若机器人主控使用apm架构飞控，设置参数如下可以进入Loiter模式

| 参数名称              | 设置值         | 说明                          |
| ----------------- | ----------- | --------------------------- |
| SERIAL2\_PROTOCOL | MAVLink2    | 将串口 2 协议设置为 MAVLink 2       |
| SERIAL2\_BAUD     | 115200      | 串口 2 波特率设置为 115200 bps      |
| BRD\_SER2\_RTSCTS | Disable     | 禁用串口 2 的硬件流控（RTS/CTS）       |
| AHRS\_EKF\_TYPE   | Enable EKF3 | 启用 EKF3 作为姿态估计器             |
| EK3\_SRC1\_POSXY  | ExternalNav | EKF3 主数据源：XY 平面位置使用外部导航数据   |
| EK3\_SRC1\_VELXY  | ExternalNav | EKF3 主数据源：XY 平面速度使用外部导航数据   |
| EK3\_SRC1\_YAW    | ExternalNav | EKF3 主数据源：航向角使用外部导航数据       |
| VISO\_TYPE        | MAVLink     | 视觉里程计类型设置为 MAVLink 协议       |

